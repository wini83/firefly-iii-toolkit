{% extends "base.html" %}
{% block content %}

<!-- STEPS -->
<div class="card w-full p-6 bg-base-100 shadow-xl mt-2">
    <ul class="steps hidden md:flex flex-none w-1/2">
        <li class="step"><a href="/upload">Upload</a></li>
        <li class="step"><a href="/file/{{ file_id }}">Preview</a></li>
        <li class="step step-primary"><a href="/match/{{ file_id }}">Match</a></li>
        <li class="step">Update</li>
    </ul>
</div>

<!-- MAIN CARD -->
<div class="card w-full p-6 bg-base-100 shadow-xl mt-2">
    <div class="text-xl font-semibold">Matchowanie transakcji</div>
    <div class="divider mt-2"></div>

    <div id="matchContainer">
        <div role="alert" class="alert alert-info shadow">
            <span>Ładowanie danych…</span>
        </div>
    </div>
</div>

<!-- TOAST AREA -->
<div id="toastArea" class="toast toast-top toast-end"></div>

<script>
    /* ---------------------------------------------------------
       INITIAL LOAD
    --------------------------------------------------------- */
    document.addEventListener("DOMContentLoaded", () => {
        const token = localStorage.getItem("access_token");
        if (!token) return (window.location.href = "/login");

        htmx.ajax("GET", "/api/file/do-match/{{ file_id }}", "#matchContainer");
    });

    /* ---------------------------------------------------------
       RENDER MATCH TABLE
    --------------------------------------------------------- */
    document.body.addEventListener("htmx:afterOnLoad", evt => {
        if (evt.detail.target.id !== "matchContainer") return;

        let data;
        try { data = JSON.parse(evt.detail.xhr.responseText); }
        catch {
            showToast("error", "Niepoprawna odpowiedź serwera");
            return;
        }

        const rows = data.content || [];

        if (!rows.length) {
            document.getElementById("matchContainer").innerHTML =
                `<div class="alert alert-warning shadow">Brak danych do matchowania.</div>`;
            return;
        }

        const html = `
        <form id="matchForm" class="space-y-4">
            <div class="overflow-x-auto w-full rounded-lg border border-base-300 shadow">
                <table class="table w-full">
                    <thead>
                        <tr>
                            <th>Firefly TX</th>
                            <th>Dopasowania CSV</th>
                            <th>Status</th>
                            <th>Akcja</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${rows.map(r => renderMatchRow(r)).join("")}
                    </tbody>
                </table>
            </div>

           <button
    type="button"
    class="btn btn-primary mt-4"
    onclick="applyMatches()"
>
    ✔ Zastosuj dopasowania
</button>
        </form>
    `;

        const container = document.getElementById("matchContainer");
        container.innerHTML = html;

        // --- KEY: Activate hx-* inside new DOM ---
        htmx.process(container);
    });

    /* ---------------------------------------------------------
       FORCE JSON PAYLOAD FOR APPLY_MATCH
    --------------------------------------------------------- */
    async function applyMatches() {
        const form = document.getElementById("matchForm");
        const selected = form.querySelectorAll("input[name='csv_indexes']:checked");

        const arr = [...selected].map(x => parseInt(x.value));

        console.log("wysyłam JSON:", arr);

        const resp = await fetch("/api/file/apply_match/{{ file_id }}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "Authorization": "Bearer " + localStorage.getItem("access_token")
            },
            body: JSON.stringify({ csv_indexes: arr })
        });

        if (!resp.ok) {
            showToast("error", "Błąd przy zapisie dopasowań");
            return;
        }

        showToast("success", "Dopasowania zapisane!");

        // ✨ odśwież match view
        //htmx.ajax("GET", "/api/file/do-match/{{ file_id }}", "#matchContainer");
    }

    /* ---------------------------------------------------------
       TOASTS
    --------------------------------------------------------- */
    document.body.addEventListener("htmx:afterRequest", evt => {
        if (evt.detail.target.id !== "matchContainer") return;

        if (evt.detail.xhr.status === 200) {
            showToast("success", "Dopasowania zapisane!");
        } else {
            showToast("error", "Nie udało się zapisać dopasowań");
        }
    });

    function showToast(type, msg) {
        const id = "t" + Date.now();
        const map = {
            info: "alert-info",
            success: "alert-success",
            error: "alert-error",
            warning: "alert-warning"
        };

        document.getElementById("toastArea").insertAdjacentHTML(
            "beforeend",
            `<div id="${id}" class="alert ${map[type]} shadow-lg"><span>${msg}</span></div>`
        );

        setTimeout(() => {
            const el = document.getElementById(id);
            if (el) el.remove();
        }, 3000);
    }

    /* ---------------------------------------------------------
       RENDER SINGLE ROW
    --------------------------------------------------------- */
    function renderMatchRow(r) {
        const tx = r.tx;
        const matches = r.matches || [];

        const tagsHtml = tx.tags?.length
            ? tx.tags.map(t => `
            <div class="px-2 py-0.5 bg-base-200 rounded-full text-xs border border-base-300 max-w-[160px]
                        overflow-hidden text-ellipsis" title="${t}">
                ${t}
            </div>
        `).join("")
            : `<span class='opacity-50 text-xs'>brak</span>`;

        const fireflyHtml = `
        <b>${tx.date}</b><br>
        ID: ${tx.id}<br>
        Kwota: ${tx.amount} PLN<br>
        Opis: ${tx.description}<br>
        <div class="flex flex-wrap gap-2 mt-2">${tagsHtml}</div>
        <span class="opacity-70 text-xs">${tx.notes ?? ""}</span>
    `;

        let csvHtml = "-";
        if (matches.length > 0) {
            csvHtml = matches.map(m => `
            <div class="mb-3">
                <b>${m.date}</b><br>
                Kwota: ${m.operation_amount} ${m.operation_currency}<br>
                Szczegóły: ${m.details}<br>
                Nadawca: ${m.sender}<br>
                Odbiorca: ${m.recipient}<br>
                <span class="opacity-70 text-xs">
                    ${m.sender_account}<br>
                    ${m.recipient_account}
                </span>
            </div>
        `).join("<hr class='my-2'>");
        }

        let status = "Brak dopasowania";
        let color = "text-gray-500";
        let checkbox = "";

        if (matches.length === 1) {
            status = "✔ 1 dopasowanie";
            color = "text-green-600 font-semibold";
            checkbox = `<input type="checkbox" class="checkbox checkbox-primary" name="csv_indexes" value="${tx.id}">`;
        } else if (matches.length > 1) {
            status = `${matches.length} możliwych dopasowań`;
            color = "text-yellow-600 font-semibold";
        }

        return `
        <tr class="hover:bg-base-200">
            <td class="text-sm">${fireflyHtml}</td>
            <td class="text-sm">${csvHtml}</td>
            <td class="text-sm ${color}">${status}</td>
            <td class="text-center">${checkbox}</td>
        </tr>
    `;
    }
</script>

{% endblock %}