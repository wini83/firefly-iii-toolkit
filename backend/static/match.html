<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8" />
    <title>Firefly – Matchowanie</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.11"></script>
</head>
<body class="bg-gray-100 p-6">

<!-- LOGIN PANEL -->
<div id="loginBox" class="p-4 border rounded bg-gray-50 mb-4 max-w-sm mx-auto shadow">
    <h2 class="text-xl font-semibold mb-3">Logowanie</h2>
    <input id="loginUser" placeholder="Użytkownik" class="border p-2 w-full mb-2 rounded">
    <input id="loginPass" type="password" placeholder="Hasło" class="border p-2 w-full mb-3 rounded">

    <button id="loginBtn"
            class="w-full bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg shadow">
        Zaloguj
    </button>

    <div id="loginMsg" class="mt-2 text-red-600 text-sm"></div>
</div>

<!-- MAIN CONTENT -->
<div id="mainContent" class="hidden max-w-6xl mx-auto bg-white p-6 rounded-xl shadow space-y-6">
    <h1 class="text-2xl font-bold mb-4">Matchowanie transakcji</h1>
    <div id="matchContainer"></div>
</div>

<script>
// TOKEN HELPERS
function hasToken() {
    return !!localStorage.getItem("access_token");
}

// LOGIN HANDLER
if (document.getElementById("loginBtn")) {
    document.getElementById("loginBtn").addEventListener("click", async () => {
        const username = loginUser.value;
        const password = loginPass.value;

        const r = await fetch("/auth/token", {
            method: "POST",
            headers: {"Content-Type": "application/x-www-form-urlencoded"},
            body: new URLSearchParams({username, password})
        });

        if (!r.ok) {
            loginMsg.textContent = "Błędne dane logowania";
            return;
        }

        const data = await r.json();
        localStorage.setItem("access_token", data.access_token);
        location.reload();
    });
}

// INIT
const fileId = window.location.pathname.split("/").pop();

document.addEventListener("DOMContentLoaded", () => {
    if (hasToken()) {
        document.getElementById("loginBox").classList.add("hidden");
        document.getElementById("mainContent").classList.remove("hidden");

        // Fetch match results
        htmx.ajax("GET", `/api/file/do-match/${fileId}`, "#matchContainer");
    }
});

// JWT INTERCEPTOR

document.body.addEventListener("htmx:configRequest", (event) => {
    const token = localStorage.getItem("access_token");
    if (token) {
        event.detail.headers["Authorization"] = "Bearer " + token;
    }
});
</script>

<!-- MATCH RENDERER -->
<script>
document.body.addEventListener("htmx:afterOnLoad", (evt) => {
    if (evt.detail.target.id !== "matchContainer") return;

    let data;
    try { data = JSON.parse(evt.detail.xhr.responseText); }
    catch { return; }

    if (!data.content) return;

    const rows = data.content;

    let html = `
        <form id="matchForm" class="space-y-4">
            <div class="overflow-x-auto rounded-xl shadow border border-gray-200">
                <table class="min-w-full divide-y divide-gray-300">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">CSV</th>
                            <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Firefly</th>
                            <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Status</th>
                            <th class="px-4 py-2 text-left text-sm font-semibold text-gray-700">Akcja</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${rows.map(r => {

                            const csv = r.tx;
                            const matches = r.matches;

                            let status = "Brak dopasowania";
                            let color = "text-gray-500";
                            let matchHtml = "-";
                            let checkbox = "";

                            if (matches.length === 1) {
                                status = "1 dopasowanie";
                                color = "text-green-600";
                                matchHtml = `${matches[0].details ?? ""}`;
                                checkbox = `<input type='checkbox' name='csv_indexes' value='${csv.id}'>`;
                            }

                            if (matches.length > 1) {
                                status = `${matches.length} dopasowań`;
                                color = "text-yellow-600";
                                matchHtml = matches.map(m => `<div>- ${m.details ?? ""}</div>`).join("");
                            }

                            return `
                                <tr class="hover:bg-gray-50">
                                    <td class="px-4 py-2 text-sm text-gray-700">
                                        <b>Data:</b> ${csv.date ?? ""}<br>
                                        <b>Kwota:</b>${csv.amount ?? ""}<br>
                                        <b>Opis:</b>${csv.description ?? ""}<br>
                                        <b>Notatki:</b> ${csv.notes ?? ""}
                                    </td>

                                    <td class="px-4 py-2 text-sm text-gray-700">
                                        ${matchHtml}
                                    </td>

                                    <td class="px-4 py-2 text-sm font-semibold ${color}">
                                        ${status}
                                    </td>

                                    <td class="px-4 py-2">
                                        ${checkbox}
                                    </td>
                                </tr>
                            `;
                        }).join("")}
                    </tbody>
                </table>
            </div>

            <button
                hx-post="/api/file/apply_match/${fileId}"
                hx-target="#matchContainer"
                hx-include="#matchForm"
                class="bg-blue-700 hover:bg-blue-800 text-white px-5 py-2 rounded-lg shadow">
                ✔ Zastosuj dopasowania
            </button>
        </form>
    `;

    document.getElementById("matchContainer").innerHTML = html;
});
</script>

</body>
</html>
